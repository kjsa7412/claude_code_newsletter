<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.prompthub.api.template.TemplateMapper">

    <!-- ================================================================
         ResultMap: templates + profiles JOIN 결과 매핑
         map-underscore-to-camel-case=true 이지만 alias 컬럼은 명시 필요
         ================================================================ -->
    <resultMap id="templateResultMap" type="com.prompthub.api.template.Template">
        <id     property="id"             column="id"               javaType="java.util.UUID" typeHandler="org.apache.ibatis.type.UUIDTypeHandler"/>
        <result property="ownerId"        column="owner_id"         javaType="java.util.UUID" typeHandler="org.apache.ibatis.type.UUIDTypeHandler"/>
        <result property="title"          column="title"/>
        <result property="description"    column="description"/>
        <result property="isPublic"       column="is_public"/>
        <result property="storagePath"    column="storage_path"/>
        <result property="useCount"       column="use_count"/>
        <result property="createdAt"      column="created_at"       javaType="java.time.OffsetDateTime"/>
        <result property="updatedAt"      column="updated_at"       javaType="java.time.OffsetDateTime"/>
        <!-- profiles JOIN -->
        <result property="ownerDisplayName" column="owner_display_name"/>
        <result property="ownerAvatarUrl"   column="owner_avatar_url"/>
    </resultMap>

    <!-- ================================================================
         공통 SELECT 컬럼 절
         ================================================================ -->
    <sql id="selectColumns">
        t.id,
        t.owner_id,
        t.title,
        t.description,
        t.is_public,
        t.storage_path,
        t.use_count,
        t.created_at,
        t.updated_at,
        p.display_name AS owner_display_name,
        p.avatar_url   AS owner_avatar_url
    </sql>

    <sql id="joinProfiles">
        FROM templates t
        LEFT JOIN profiles p ON p.id = t.owner_id
    </sql>

    <!-- ================================================================
         findAll: 목록 조회
         filter = "mine"   -> 본인 소유
         filter = "public" -> 공개 템플릿 전체
         filter = "all"    -> 본인 소유 OR 공개
         ================================================================ -->
    <select id="findAll" resultMap="templateResultMap">
        SELECT
            <include refid="selectColumns"/>
        <include refid="joinProfiles"/>
        <where>
            <choose>
                <when test="filter == 'mine'">
                    t.owner_id = #{currentUserId}::uuid
                </when>
                <when test="filter == 'public'">
                    t.is_public = true
                </when>
                <otherwise>
                    (t.owner_id = #{currentUserId}::uuid OR t.is_public = true)
                </otherwise>
            </choose>
        </where>
        ORDER BY t.updated_at DESC
    </select>

    <!-- ================================================================
         findById: 단건 조회
         ================================================================ -->
    <select id="findById" resultMap="templateResultMap">
        SELECT
            <include refid="selectColumns"/>
        <include refid="joinProfiles"/>
        WHERE t.id = #{id}::uuid
    </select>

    <!-- ================================================================
         insert: 생성
         ================================================================ -->
    <insert id="insert" parameterType="com.prompthub.api.template.Template">
        INSERT INTO templates (
            id,
            owner_id,
            title,
            description,
            is_public,
            storage_path,
            use_count,
            created_at,
            updated_at
        ) VALUES (
            #{id}::uuid,
            #{ownerId}::uuid,
            #{title},
            #{description},
            #{isPublic},
            #{storagePath},
            #{useCount},
            #{createdAt},
            #{updatedAt}
        )
    </insert>

    <!-- ================================================================
         update: 수정 (V-12: owner_id 조건을 DB 레벨에서도 강제)
         ================================================================ -->
    <update id="update" parameterType="com.prompthub.api.template.Template">
        UPDATE templates
        SET
            title        = #{title},
            description  = #{description},
            is_public    = #{isPublic},
            updated_at   = #{updatedAt}
        WHERE id       = #{id}::uuid
          AND owner_id = #{ownerId}::uuid
    </update>

    <!-- ================================================================
         deleteById: 삭제 (owner_id 조건 포함하여 DB 레벨에서도 보호)
         ================================================================ -->
    <delete id="deleteById">
        DELETE FROM templates
        WHERE id       = #{id}::uuid
          AND owner_id = #{ownerId}::uuid
    </delete>

    <!-- ================================================================
         incrementUseCount: use_count 원자적 증가
         ================================================================ -->
    <update id="incrementUseCount">
        UPDATE templates
        SET use_count  = use_count + 1,
            updated_at = NOW()
        WHERE id = #{id}::uuid
    </update>

</mapper>
