<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.prompthub.api.ranking.RankingMapper">

    <!-- ================================================================
         ResultMap: 랭킹 결과 매핑
         ================================================================ -->
    <resultMap id="rankingResultMap" type="com.prompthub.api.ranking.RankingDto">
        <result property="rank"             column="rank"/>
        <result property="templateId"       column="template_id"       javaType="java.util.UUID"/>
        <result property="title"            column="title"/>
        <result property="description"      column="description"/>
        <result property="ownerId"          column="owner_id"          javaType="java.util.UUID"/>
        <result property="ownerDisplayName" column="owner_display_name"/>
        <result property="ownerAvatarUrl"   column="owner_avatar_url"/>
        <result property="useCountWeekly"   column="use_count_weekly"/>
    </resultMap>

    <!-- ================================================================
         findWeeklyRanking: 최근 7일간 usage_events 집계 Top N
         - 공개 템플릿만 포함 (is_public = true)
         - RANK() 윈도우 함수로 동점 처리
         ================================================================ -->
    <select id="findWeeklyRanking" resultMap="rankingResultMap">
        SELECT
            RANK() OVER (ORDER BY weekly.use_count_weekly DESC) AS rank,
            weekly.template_id,
            t.title,
            t.description,
            t.owner_id,
            p.display_name  AS owner_display_name,
            p.avatar_url    AS owner_avatar_url,
            weekly.use_count_weekly
        FROM (
            SELECT
                template_id,
                COUNT(*) AS use_count_weekly
            FROM usage_events
            WHERE used_at >= NOW() - INTERVAL '7 days'
            GROUP BY template_id
        ) weekly
        INNER JOIN templates t
            ON t.id = weekly.template_id
            AND t.is_public = true
        LEFT JOIN profiles p
            ON p.id = t.owner_id
        ORDER BY weekly.use_count_weekly DESC, t.created_at ASC
        LIMIT #{limit}
    </select>

</mapper>
